# Graphite Apache Virtual Host
#
# Generated by Chef
<VirtualHost *:80>
   ServerAdmin <%= node['apache']['contact'] %>

   ServerName <%= node['jenkins_ci']['apache']['service_name'] %>
   ServerAlias <%= node['fqdn'] %>

   Redirect permanent / https://<%= node['jenkins_ci']['apache']['service_name'] -%>/

   # Possible values: debug, info, notice, warn, error, crit, alert, emerg
   LogLevel warn
   CustomLog ${APACHE_LOG_DIR}/access-apache-biservices-http.log combined
   ErrorLog ${APACHE_LOG_DIR}/error-apache-biservices-http.log
</VirtualHost>

<VirtualHost *:443>
   ServerAdmin <%= node['apache']['contact'] %>

   ServerName <%= node['jenkins_ci']['apache']['service_name'] %>
   ServerAlias <%= node['fqdn'] %>

   <IfModule mod_ssl.c>
      SSLEngine On
      SSLCertificateFile    <%= node['jenkins_ci']['apache']['ssl_cert_path'] %>
      SSLCertificateKeyFile <%= node['jenkins_ci']['apache']['ssl_key_path'] %>
   </IfModule>

   ProxyRequests Off
   ProxyPreserveHost On
   AllowEncodedSlashes NoDecode
   <Proxy *>
      Require all granted
   </Proxy>
   ProxyPass         /  http://localhost:8080/ nocanon
   ProxyPassReverse  /  http://localhost:8080/
   ProxyPassReverse  /  http://<%= node['jenkins_ci']['apache']['service_name'] %>/
   RequestHeader set X-Forwarded-Proto "https"
   RequestHeader set X-Forwarded-Port "443"

   # Possible values: debug, info, notice, warn, error, crit, alert, emerg
   LogLevel warn
   CustomLog ${APACHE_LOG_DIR}/access-apache-biservices-https.log combined
   ErrorLog ${APACHE_LOG_DIR}/error-apache-biservices-https.log
</VirtualHost>
